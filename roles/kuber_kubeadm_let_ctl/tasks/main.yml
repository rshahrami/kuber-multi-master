---
# tasks file for kuber_kubeadm_let_ctl

- name: add sd kubernetes.repo
  yum_repository:
    name: kubernetes
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
    enabled: yes
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    exclude:
      - kubelet
      - kubeadm
      - kubectl
    description: kubernetes
    

- name: disable selinux
  selinux:
    state: disabled


- name: ensure selinux is set to enforcing module
  lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX=disabled$'
    line: SELINUX=permissive

- name: Reboot
  reboot:
    reboot_timeout: 180

- name: add shekan for kubernetes
  shell: |
    cat <<EOF | sudo tee /etc/resolv.conf
    # Generated by NetworkManager
    nameserver 178.22.122.100
    nameserver 185.51.200.2
    nameserver 8.8.8.8
    EOF

- name: install kubeadm, kubectl and kubelet 
  command: yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

- name: check install kubeadm, kubectl and kubelet
  package_facts:
    manager: "auto"

- name: kubeadm, kubectl and kubelet not found
  debug:
    msg: kubeadm, kubectl and kubelet not found
    var: ansible_facts.packages
  when: ('kubeadm' not in ansible_facts.packages) and ('kubectl' not in ansible_facts.packages) and ('kubelet' not in ansible_facts.packages)



- name: restart kubelet
  service:
    name: kubelet
    state: started
    enabled: yes
  when: ('kubeadm' in ansible_facts.packages) and ('kubectl' in ansible_facts.packages) and ('kubelet' in ansible_facts.packages)
